TRAFFICSERVER_VERSION = 9.1.2
BUILD_VERSION_REPOSHA = $(shell git rev-parse --short HEAD)
TRAFFICSERVER_BUILD_VERSION = mangadex-$(BUILD_VERSION_REPOSHA)

TRAFFICSERVER_SOURCES = https://codeload.github.com/apache/trafficserver/tar.gz/$(TRAFFICSERVER_VERSION)
TRAFFICSERVER_TARBALL = trafficserver-$(TRAFFICSERVER_VERSION).tar.gz
TRAFFICSERVER_BUILDIR = src
TRAFFICSERVER_DESTDIR = dist
TRAFFICSERVER_DESTDIR_ABS = $(shell realpath $(TRAFFICSERVER_DESTDIR))
TRAFFICSERVER_ARCHIVE = trafficserver-dist.tar.gz

TRAFFICSERVER_RUN_TESTS = true

all: build $(TRAFFICSERVER_DESTDIR) $(TRAFFICSERVER_ARCHIVE)

$(TRAFFICSERVER_TARBALL):
	curl -sfS -o "$(TRAFFICSERVER_TARBALL)" "$(TRAFFICSERVER_SOURCES)"

$(TRAFFICSERVER_BUILDIR): $(TRAFFICSERVER_TARBALL)
	@if ! [ -d "$(TRAFFICSERVER_BUILDIR)" ]; then mkdir -v "$(TRAFFICSERVER_BUILDIR)"; fi
	tar -C $(TRAFFICSERVER_BUILDIR) --strip-components=1 -xf "$(TRAFFICSERVER_TARBALL)"

build: $(TRAFFICSERVER_BUILDIR)
	cd "$(TRAFFICSERVER_BUILDIR)" && autoreconf -if
	cd "$(TRAFFICSERVER_BUILDIR)" && ./configure \
		--enable-layout="Debian" \
		--with-build-number="+$(TRAFFICSERVER_BUILD_VERSION)"
	$(MAKE) -C "$(TRAFFICSERVER_BUILDIR)" -j "$(shell nproc)"
	if $(TRAFFICSERVER_RUN_TESTS); then $(MAKE) -C "$(TRAFFICSERVER_BUILDIR)" -j "$(shell nproc)" check; fi

$(TRAFFICSERVER_DESTDIR): build
	@if ! [ -d "$(TRAFFICSERVER_DESTDIR)" ]; then mkdir -v "$(TRAFFICSERVER_DESTDIR)"; fi
	$(MAKE) -C "$(TRAFFICSERVER_BUILDIR)" -j "$(shell nproc)" install DESTDIR="$(TRAFFICSERVER_DESTDIR_ABS)"
	LD_LIBRARY_PATH=$(TRAFFICSERVER_DESTDIR_ABS)/usr/lib/trafficserver $(TRAFFICSERVER_DESTDIR_ABS)/usr/bin/traffic_manager --version

$(TRAFFICSERVER_ARCHIVE): $(TRAFFICSERVER_DESTDIR)
	tar -C "$(TRAFFICSERVER_DESTDIR)" -cjf "$(TRAFFICSERVER_ARCHIVE)" $(shell ls -1 $(TRAFFICSERVER_DESTDIR_ABS))

clean:
	rm -fv "$(TRAFFICSERVER_TARBALL)"
	rm -rf "$(TRAFFICSERVER_BUILDIR)"
	rm -rf "$(TRAFFICSERVER_DESTDIR)"
	rm -fv "$(TRAFFICSERVER_ARCHIVE)"

.PHONY: clean build
